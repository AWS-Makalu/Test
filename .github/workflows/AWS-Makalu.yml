#----------------------------------------------------
# GitHub Action Part 1
# AWS-Makalu
# ğŸ’¥ âœ… âŒ ğŸ’ğŸ“â˜˜ğŸŒ¹ğŸ’š
# ğŸ‘¨â€ğŸ“ğŸ‘¨â€ğŸ«ğŸ‘¨â€ğŸ”¬ğŸ‘¨â€ğŸ”§ğŸ‘ŒğŸ‘¨â˜¯â˜¯ğŸ‘ŒğŸ‘¨â˜âœŒâ€âœ”ï¸âŒ
# AAA=$(printf "âœ” Status\n") # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
# IMAGE_ID=docker.pkg.github.com/${{ github.repository }}/${IMAGE_NAME}
# $ docker ps -q | xargs  docker stats --no-stream # Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸ Ğ¸ CPU Ğ²ÑĞµÑ… Docker
#----------------------------------------------------

name: CI_AWS-Makalu
  
env:
  APPLICATION_NAME    : "APPLICATION_NAME"
  DEPLOY_PACKAGE_NAME : "AWS_Deploy-ver-${{ github.sha }}"
  TELEGRAM_TOKEN      : "1082481725:AAEraZTXO5Wjq4tYmT0O68KWlgUpsn0coa0"
  TELEGRAM_CHAT_ID    : "954432616"
  DATE_GIT            :  GIT_AUTHOR_DATE

on:                                             # ĞšĞ¾Ğ³Ğ´Ğ° ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ
  push:
    branches: 
      - master                                  # Ğ’ĞµÑ‚ĞºĞ°
jobs:
  JOB_CI:                                       # Job name
    runs-on : ubuntu-latest                     # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğµ Linux
    steps   :
    - name  : ğŸ’Git Clone my Repo               # CHECKOUT
      uses  : actions/checkout@v1

    - name  : ğŸ’ALL ZIP
      run   : zip -r ${{ env.DEPLOY_PACKAGE_NAME }}.zip ./ -x "*.git*"     
       
    - name  : ğŸ’List corrent dir
      run   : |
                ls -la
                printf "\033[1;32m  âœ” Status\033[0m \n"
                echo "Status:ğŸ’${{ job.status }}" 
                echo "Status:ğŸ’${{ env.DATE_GIT }}"  
     
    - name  : ğŸ’If error JOB_CI                 # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Error
      if    : failure()   
      run   : |
                TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S") # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ñ€ĞµĞ¼Ñ
                echo "ğŸ’ ${TIME}ğŸ’"
                curl -s -X POST \
                https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
                -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
                -d text="âŒ Err Master JOB_CI ğŸ’%0A ${TIME}" 
             
    - name  : ğŸ’If All Ok JOB_CI                # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞĞš
      if    : success()   
      run   : |
                TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S") # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ñ€ĞµĞ¼Ñ
                echo "ğŸ’ ${TIME}ğŸ’"
                curl -s -X POST \
                https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
                -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
                -d text="â˜˜ OK JOB_CI ğŸ’%0A ${TIME}" 
        
  JOB_CD    :                                   # Job name
    runs-on : ubuntu-latest                     # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğµ Linux
    needs   : [JOB_CI]                          # Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¸ JOB_CI success
    steps   :
    - name  : Deploy                            
      run   : |
                TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S") # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ñ€ĞµĞ¼Ñ
                echo "ğŸ’ ${TIME}ğŸ’"
                curl -s -X POST \
                https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
                -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
                -d text="â˜˜ Push AWSğŸ’%0A ${TIME}" 


