#----------------------------------------------------
# GitHub Action Part 1
# AWS-Makalu
# 💥 ✅ ❌ 🍒🍓☘🌹💚
# 👨‍🎓👨‍🏫👨‍🔬👨‍🔧👌👨☯☯👌👨☝✌‍✔️❌
# AAA=$(printf "✔ Status\n")
# IMAGE_ID=docker.pkg.github.com/${{ github.repository }}/${IMAGE_NAME}
#----------------------------------------------------

name: CI_AWS-Makalu
  
env:
  APPLICATION_NAME    : "APPLICATION_NAME"
  DEPLOY_PACKAGE_NAME : "AWS_Deploy-ver-${{ github.sha }}"
  TELEGRAM_TOKEN      : "1082481725:AAEraZTXO5Wjq4tYmT0O68KWlgUpsn0coa0"
  TELEGRAM_CHAT_ID    : "954432616"

on:                                             # Когда срабатывать
  push:
    branches: 
      - master                                  # Ветка
jobs:
  JOB_CI:                                       # Test
    runs-on : ubuntu-latest                     # Выполнить в контейнере Linux
    steps   :
    - name  : 🍒Git Clone my Repo               # CHECKOUT
      uses  : actions/checkout@v1

    - name  : 🍒ALL ZIP
      run   : zip -r ${{ env.DEPLOY_PACKAGE_NAME }}.zip ./ -x "*.git*"     
       
    - name  : 🍒List corrent dir
      run   : |
            ls -la
            printf "\033[1;32m  ✔ Status\033[0m \n"
            echo "Status:🍒${{ job.status }}"  
     
    - name  : 🍒If error JOB_CI                 # Если предыдущий шаг с ошибкой - выполнить
      if    : failure()   
      run   : |
              TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S")
              echo "🍒 ${TIME}🍒"
              echo "Hello World testing:${TIME}"
              curl -s -X POST \
              https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
              -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
              -d text="❌ Err Master JOB_CI 🍒%0A ${TIME}" 
             
    - name  : 🍒If All Ok JOB_CI                # Все ОК
      if    : success()   
      run   : |
              TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S")
              echo "🍒 ${TIME}🍒"
              echo "Hello World testing:${TIME}"
              curl -s -X POST \
              https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
              -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
              -d text="☘ OK JOB_CI 🍒%0A ${TIME} ${AAA}" 
        
  JOB_CD    :                                   # Deploy
    runs-on : ubuntu-latest                     # Выполнить в контейнере Linux
    needs   :  [JOB_CI]                         # Выполнить только если прошло  задание JOB_Testing
    steps   :
    - name  : Deploy                            # Deploy
      run   : |
              TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S")
              echo "${TIME}"
              echo "Hello World testing:${TIME}"
              curl -s -X POST \
              https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
              -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
              -d text="☘ Push AWS🍒%0A ${TIME}" 


