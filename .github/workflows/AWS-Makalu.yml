#----------------------------------------------------
# GitHub Action Part 1
# AWS-Makalu
# –ú–∏—Ä–æ–Ω–µ–Ω–∫–æ –û.–ò. ùõÄ
# 2020-02-26 –Ω–∞—á–∞–ª–æ
# üí• ‚úÖ ‚ùå üçíüçì‚òòüåπüíö üë®üèª‚Äçüéì
# $ docker ps -q | xargs  docker stats --no-stream # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –∏ CPU –≤—Å–µ—Ö Docker
#----------------------------------------------------

name: CI_AWS-Makalu
  
env:
  APPLICATION_NAME    : "APPLICATION_NAME"
  DEPLOY_PACKAGE_NAME : "AWS_Deploy-ver-${{ github.sha }}"
  TELEGRAM_TOKEN      : "1082481725:AAEraZTXO5Wjq4tYmT0O68KWlgUpsn0coa0"
  TELEGRAM_CHAT_ID    : "954432616"

on:                                             # –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å
  push:                                         # –ü—Ä–∏ Push
    branches: 
      - master                                  # –í–µ—Ç–∫–∞ –Ω–∞ –∫–æ—Ç–æ—Ä—É—é —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
jobs:                                           # –ü–µ—Ä–µ—á–µ–Ω—å —Ä–∞–±–æ—Ç 
  JOB_CI:                                       # Job CI
    runs-on : ubuntu-latest                     # –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ Linux
    steps   :                                   # –®–∞–≥–∏ –≤ —Ä–∞–±–æ—Ç–µ
    - name  : üçíGit Clone my Repo               # CHECKOUT –ö–ª–æ–Ω–∏—Ä—É–µ–º
      uses  : actions/checkout@v1

    - name  : üçíALL ZIP
      run   : zip -r ${{ env.DEPLOY_PACKAGE_NAME }}.zip ./ -x "*.git*"     
       
    - name  : üçíList corrent dir
      run   : |
                ls -la
                printf "üçí\033[1;33m Status:${{ job.status }}\033[0m \n"
     
    - name  : üçíIf error JOB_CI                 
      if    : failure()                         # –í—ã–ø–æ–ª–Ω–∏—Ç—å —à–∞–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–∞—Ö
      run   : |
                TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S") # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –≤—Ä–µ–º—è
                #------------------- Telegram ----------------------
                printf "üçí\033[1;33m ${TIME}üçí\033[0m \n"
                curl -s -X POST \
                https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
                -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
                -d text="‚ùå AWS-Makalu üçí%0A           JOB_CI %0A ${TIME}" 
             
  JOB_CD    :                                   # Job CD
    runs-on : ubuntu-latest                     # –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ Linux 
    needs   : [JOB_CI]                          # –í—ã–ø–æ–ª–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∏–∏ JOB_CI –∑–∞–∫–æ–Ω—á–µ–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
    steps   :
    - name  : üçíIf error Deploy                 
      if    : failure()                         # –í—ã–ø–æ–ª–Ω–∏—Ç—å —à–∞–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–∞—Ö (steps!)
      run   : |
                TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S") # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –≤—Ä–µ–º—è
                #------------------- Telegram ----------------------
                printf "üçí\033[1;33m ${TIME}üçí\033[0m \n"
                curl -s -X POST \
                https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
                -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
                -d text="‚ùå AWS-Makalu üçí%0A           JOB_CD %0A ${TIME}" 
                 
    - name  : üçíIf OK Deploy                           
      if    : success()                         # –í—ã–ø–æ–ª–Ω–∏—Ç—å —à–∞–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–∞—Ö –æ—à–∏–±–æ–∫ –Ω–µ –±—ã–ª–æ (steps!)   
      run   : |
                TIME=$(TZ=MSK-3 date "+%d.%m.%Y_%H:%M:%S") # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞—Ç—É –≤—Ä–µ–º—è
                #------------------- Telegram ----------------------
                printf "üçí\033[1;33m ${TIME}üçí\033[0m \n"
                curl -s -X POST \
                https://api.telegram.org/bot${{ env.TELEGRAM_TOKEN }}/sendMessage \
                -d chat_id=${{ env.TELEGRAM_CHAT_ID }} \
                -d text="‚òòÔ∏è AWS-Makalu üçíüë®üèª‚Äçüéì%0A       Deploy AWS %0A ${TIME}" 


